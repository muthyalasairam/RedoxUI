<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Redox Questions</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .right-align {
            float: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="mt-5">Manage Questions</h2>
        <button id="dashboardButton" class="btn btn-info mb-3 right-align">Go to Dashboard</button>
        <button id="viewQuestionsButton" class="btn btn-info mb-3 right-align mr-2">View Questions</button>
        
        <!-- Form for Questions -->
        <form id="questionForm" novalidate>
            <div class="form-group">
                <label for="level">Select Level</label>
                <select class="form-control" id="level" onchange="toggleLevel4Format()">
                    <option value="1">Level 1 & 2</option>
                    <option value="3">Level 3</option>
                    <option value="4">Level 4-I</option>
                    <option value="5">Level 4-II</option>
                </select>
            </div>
            
            <!-- Default format for Levels 1, 2, and 3 -->
            <div id="default-format">
                <div class="form-group">
                    <div id="toolbar1">
                        <button type="button" class="ql-script" value="sub">Subscript</button>
                        <button type="button" class="ql-script" value="super">Superscript</button>
                        <button type="button" id="arrowButton1">→</button>
                    </div>
                    <label for="question_text">Question:</label>
                    <div id="equationEditor1" class="form-control" style="min-height: 50px;"></div>
                    <input type="hidden" class="form-control" id="question_text" name="question_text" required>
                </div>
                <div class="form-group">
                    <label for="option1">Option 1 (Correct Answer):</label>
                    <input type="text" class="form-control" id="option1" name="option1" placeholder="Correct Answer" required>
                </div>
                <div class="form-group">
                    <label for="option2">Option 2 (Incorrect Answer):</label>
                    <input type="text" class="form-control" id="option2" name="option2" placeholder="Incorrect Answer" required>
                </div>
                <div class="form-group">
                    <label for="option3">Option 3 (Incorrect Answer):</label>
                    <input type="text" class="form-control" id="option3" name="option3" placeholder="Incorrect Answer" required>
                </div>
                <div class="form-group">
                    <label for="option4">Option 4 (Incorrect Answer):</label>
                    <input type="text" class="form-control" id="option4" name="option4" placeholder="Incorrect Answer" required>
                </div>
            </div>
            
            <!-- Custom format for Level 4-I and Level 4-II -->
            <div id="level4-format" style="display: none;">
                <div class="form-group">
                    <label for="question_text_4">Level 4 Question:</label>
                    <input type="text" class="form-control" id="question_text_4" name="question_text_4" required>
                </div>
                <div class="form-group">
                    <div id="toolbar">
                        <button type="button" class="ql-script" value="sub">Subscript</button>
                        <button type="button" class="ql-script" value="super">Superscript</button>
                        <button type="button" id="arrowButton">→</button>
                    </div>
                    <label for="equation">Equation (if applicable):</label>
                    <div id="equationEditor" class="form-control" style="min-height: 50px;"></div>
                    <input type="hidden" id="equationInput" name="equation">
                </div>
                <div class="form-group">
                    <label for="correct_option">Correct Answer:</label>
                    <input type="text" class="form-control" id="correct_option" name="correct_option" placeholder="Correct Answer" required>
                </div>
                <div id="additional-options" class="form-group">
                    <label>Other Options:</label>
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" placeholder="Incorrect Answer" required>
                        <div class="input-group-append">
                            <button type="button" class="btn btn-danger" onclick="removeOption(this)">Remove</button>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary" onclick="addOption()">Add Option</button>
            </div>
            
            <!-- Submit button -->
            <button type="submit" class="btn btn-info mt-3">Add Question</button>
        </form>
        
        <div id="questionsList" class="mt-5"></div>
    </div>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const quill = new Quill('#equationEditor', {
                theme: 'snow',
                modules: {
                    toolbar: {
                        container: '#toolbar'
                    }
                }
            });
            const quill1 = new Quill('#equationEditor1', {
                theme: 'snow',
                modules: {
                    toolbar: {
                        container: '#toolbar1'
                    }
                }
            });

            document.getElementById('arrowButton').addEventListener('click', () => {
                const arrowSymbol = '→';
                const range = quill.getSelection();
                if (range) {
                    quill.insertText(range.index, arrowSymbol);
                    quill.setSelection(range.index + arrowSymbol.length);
                }
            });
            
            document.getElementById('arrowButton1').addEventListener('click', () => {
                const arrowSymbol = '→';
                const range = quill1.getSelection();
                if (range) {
                    quill1.insertText(range.index, arrowSymbol);
                    quill1.setSelection(range.index + arrowSymbol.length);
                }
            });

            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            document.getElementById('viewQuestionsButton').addEventListener('click', () => {
                window.location.href = '/viewquestions.html';
            });
            document.getElementById('dashboardButton').addEventListener('click', () => {
                window.location.href = '/dashboard.html';
            });

            // Function to convert <sub> and <sup> HTML tags to Unicode characters
                function convertHtmlToUnicode(html) {
    // Subscript conversion
    html = html.replace(/<sub>(.*?)<\/sub>/g, (_, text) => {
        const subMap = {
            '0': '₀', '1': '₁', '2': '₂', '3': '₃', '4': '₄',
            '5': '₅', '6': '₆', '7': '₇', '8': '₈', '9': '₉',
            '+': '₊', '-': '₋'
        };
        return text.split('').map(char => subMap[char] || char).join('');
    });

    // Superscript conversion
    html = html.replace(/<sup>(.*?)<\/sup>/g, (_, text) => {
        const supMap = {
            '0': '⁰', '1': '¹', '2': '²', '3': '³', '4': '⁴',
            '5': '⁵', '6': '⁶', '7': '⁷', '8': '⁸', '9': '⁹',
            '+': '⁺', '-': '⁻'
        };
        return text.split('').map(char => supMap[char] || char).join('');
    });

    // Remove any remaining HTML tags
    return html.replace(/<[^>]*>?/gm, '');
}

            document.getElementById('questionForm').addEventListener('submit', function(event) {
                event.preventDefault();

                // Get full HTML from Quill


                const level = document.getElementById('level').value;
                let questionData;

                if (level === "4" || level === "5") {
                    let equationHtml = quill.root.innerHTML;
                    const equationUnicode = convertHtmlToUnicode(equationHtml);
                    document.getElementById('equationInput').value = equationUnicode;

        
                    const question_text = document.getElementById('question_text_4').value;
                    const equation = document.getElementById('equationInput').value;  // Store converted Unicode text
                    const correctOption = document.getElementById('correct_option').value;

                    const options = Array.from(document.querySelectorAll('#additional-options .input-group .form-control')).map(opt => opt.value);
                    // Validation for Level 4 and 5
                if (!question_text || !equation || !correctOption || options.some(opt => !opt)) {
                     alert('Please fill in all fields before adding the question.');
                    return;
                }
                    questionData = { question_text, equation, correctOption, options };
                } else {
                    let equationHtml = quill1.root.innerHTML;
                    const equationUnicode = convertHtmlToUnicode(equationHtml);
                    document.getElementById('question_text').value = equationUnicode;
                    const question_text = document.getElementById('question_text').value;
                    const options = [
                        document.getElementById('option1').value,
                        document.getElementById('option2').value,
                        document.getElementById('option3').value,
                        document.getElementById('option4').value
                    ];
                // Validation for Levels 1, 2, and 3
                    if (!question_text || !option1 || !option2 || !option3 || !option4 || !level) {
                      alert('Please fill in all fields before adding the question.');
                    return;
                    }
                    questionData = { question_text, options };
                }

                console.log('Data to send:', questionData);

                const endpoint = `/level${level}questions`;

                fetch(endpoint, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify(questionData)
                })
                .then(response => {
    if (!response.ok) {
        throw new Error(`Server error: ${response.status}`);
    }
    return response.json(); 
})
.then(data => {
    alert('Question added successfully');
    document.getElementById('questionForm').reset();
    toggleLevel4Format();
})
.catch(error => {
    console.error('Error:', error);
    alert('There was an error adding the question. Please try again.');
});
            });
        });

        function toggleLevel4Format() {
            const level = document.getElementById('level').value;
            const isLevel4 = (level === "4" || level === "5");
    
            document.getElementById('default-format').style.display = isLevel4 ? 'none' : 'block';
            document.getElementById('level4-format').style.display = isLevel4 ? 'block' : 'none';
            
            document.querySelectorAll('#default-format input').forEach(input => {
                input.required = !isLevel4;
            });
            document.querySelectorAll('#level4-format input').forEach(input => {
                input.required = isLevel4;
            });
        }

        function addOption() {
            const optionContainer = document.createElement('div');
            optionContainer.className = 'input-group mb-2';

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control';
            input.placeholder = 'Incorrect Answer';

            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'input-group-append';

            const removeButton = document.createElement('button');
            removeButton.className = 'btn btn-danger';
            removeButton.type = 'button';
            removeButton.textContent = 'Remove';
            removeButton.onclick = () => optionContainer.remove();

            buttonGroup.appendChild(removeButton);
            optionContainer.appendChild(input);
            optionContainer.appendChild(buttonGroup);

            document.getElementById('additional-options').appendChild(optionContainer);
        }
    </script>
</body>
</html>
